  renode-smoke:
    needs: [check-renode]
    if: ${{ needs.check-renode.outputs.smoke_present == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Renode smoke in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work antmicro/renode:latest \
            sh -lc 'renode --console -e "mach create; quit"' | tee renode.log
      - name: Upload Renode log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renode-log
          path: renode.log

  check-renode:
    runs-on: ubuntu-latest
    outputs:
      smoke_present: ${{ steps.chk.outputs.present }}
    steps:
      - uses: actions/checkout@v4
      - id: chk
        run: |
          if [ -f renode/smoke.resc ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi
